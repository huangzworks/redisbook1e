<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>压缩列表节点的构成 &mdash; Redis 设计与实现</title>
    
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Redis 设计与实现" href="../../index.html" /> 

<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->


  </head>
  <body>


    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">Redis 设计与实现</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>压缩列表节点的构成<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>每个压缩列表节点可以保存一个字节数组或者一个整数值，
其中，
字节数组可以是以下三种长度的其中一种：</p>
<ol class="arabic simple">
<li>长度小于等于 <code class="docutils literal"><span class="pre">63</span></code> （<img class="math" src="../../_images/math/1736c9059eea15907ccc2c56212f14514f3e4608.png" alt="2^{6}-1"/>）字节的字节数组；</li>
<li>长度小于等于 <code class="docutils literal"><span class="pre">16383</span></code> （<img class="math" src="../../_images/math/2c1ee4b22d7e0b64b7ce1778d8ea3ac01e5d2b10.png" alt="2^{14}-1"/>） 字节的字节数组；</li>
<li>长度小于等于 <code class="docutils literal"><span class="pre">4294967295</span></code> （<img class="math" src="../../_images/math/998b86161020ab102c221730a6c5c8a2d4c4b001.png" alt="2^{32}-1"/>）字节的字节数组；</li>
</ol>
<p>而整数值则可以是以下六种长度的其中一种：</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">4</span></code> 位长，介于 <code class="docutils literal"><span class="pre">0</span></code> 至 <code class="docutils literal"><span class="pre">12</span></code> 之间的无符号整数；</li>
<li><code class="docutils literal"><span class="pre">1</span></code> 字节长的有符号整数；</li>
<li><code class="docutils literal"><span class="pre">3</span></code> 字节长的有符号整数；</li>
<li><code class="docutils literal"><span class="pre">int16_t</span></code> 类型整数；</li>
<li><code class="docutils literal"><span class="pre">int32_t</span></code> 类型整数；</li>
<li><code class="docutils literal"><span class="pre">int64_t</span></code> 类型整数。</li>
</ol>
<p>每个压缩列表节点都由 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 、 <code class="docutils literal"><span class="pre">encoding</span></code> 、 <code class="docutils literal"><span class="pre">content</span></code> 三个部分组成，
如图 7-4 所示。</p>
<p class="graphviz">
<img src="../../_images/graphviz-cc6b40e182bfc142c12ac0518819a2d949eafa4a.png" alt="digraph {

    label = &quot;\n 图 7-4    压缩列表节点的各个组成部分&quot;;

    node [shape = record];

    n [label = &quot; previous_entry_length | encoding | content &quot;];

}" />
</p>
<p>接下来的内容将分别介绍这三个组成部分。</p>
<div class="section" id="previous-entry-length">
<h2>previous_entry_length<a class="headerlink" href="#previous-entry-length" title="Permalink to this headline">¶</a></h2>
<p>节点的 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性以字节为单位，
记录了压缩列表中前一个节点的长度。</p>
<p><code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的长度可以是 <code class="docutils literal"><span class="pre">1</span></code> 字节或者 <code class="docutils literal"><span class="pre">5</span></code> 字节：</p>
<ul class="simple">
<li>如果前一节点的长度小于 <code class="docutils literal"><span class="pre">254</span></code> 字节，
那么 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的长度为 <code class="docutils literal"><span class="pre">1</span></code> 字节：
前一节点的长度就保存在这一个字节里面。</li>
<li>如果前一节点的长度大于等于 <code class="docutils literal"><span class="pre">254</span></code> 字节，
那么 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的长度为 <code class="docutils literal"><span class="pre">5</span></code> 字节：
其中属性的第一字节会被设置为 <code class="docutils literal"><span class="pre">0xFE</span></code> （十进制值 <code class="docutils literal"><span class="pre">254</span></code>），
而之后的四个字节则用于保存前一节点的长度。</li>
</ul>
<p>图 7-5 展示了一个包含一字节长 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的压缩列表节点，
属性的值为 <code class="docutils literal"><span class="pre">0x05</span></code> ，
表示前一节点的长度为 <code class="docutils literal"><span class="pre">5</span></code> 字节。</p>
<p class="graphviz">
<img src="../../_images/graphviz-bcf2d2cccedc9fa6a4d11e2331cda9d9d18e3ce7.png" alt="digraph {

    label = &quot;\n 图 7-5    当前节点的前一节点的长度为 5 字节&quot;;

    node [shape = record];

    n [label = &quot; previous_entry_length \n 0x05 | encoding \n ... | content \n ... &quot;];

}" />
</p>
<p>图 7-6 展示了一个包含五字节长 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的压缩节点，
属性的值为 <code class="docutils literal"><span class="pre">0xFE00002766</span></code> ，
其中值的最高位字节 <code class="docutils literal"><span class="pre">0xFE</span></code> 表示这是一个五字节长的 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性，
而之后的四字节 <code class="docutils literal"><span class="pre">0x00002766</span></code> （十进制值 <code class="docutils literal"><span class="pre">10086</span></code> ）才是前一节点的实际长度。</p>
<p class="graphviz">
<img src="../../_images/graphviz-ca019ee1f59f79376fbe5f2564d8d95e3ed3748c.png" alt="digraph {

    label = &quot;\n 图 7-6    当前节点的前一节点的长度为 10086 字节&quot;;

    node [shape = record];

    n [label = &quot; previous_entry_length \n 0xFE00002766 | encoding \n ... | content \n ... &quot;];

}" />
</p>
<p>因为节点的 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性记录了前一个节点的长度，
所以程序可以通过指针运算，
根据当前节点的起始地址来计算出前一个节点的起始地址。</p>
<p>举个例子，
如果我们有一个指向当前节点起始地址的指针 <code class="docutils literal"><span class="pre">c</span></code> ，
那么我们只要用指针 <code class="docutils literal"><span class="pre">c</span></code> 减去当前节点 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的值，
就可以得出一个指向前一个节点起始地址的指针 <code class="docutils literal"><span class="pre">p</span></code> ，
如图 7-7 所示。</p>
<p class="graphviz">
<img src="../../_images/graphviz-49750cc228ee403c4ef64ad1d2911154765bf3d3.png" alt="digraph {

    label = &quot;\n 图 7-7    通过指针运算计算出前一个节点的地址&quot;;

    rankdir = BT;

    node [shape = record];

    entry [label = &quot; ... | &lt;previous_entry&gt; previous_entry | &lt;current_entry&gt; current_entry | ... &quot;];

    c [label = &quot;c&quot;, shape = plaintext];
    c -&gt; entry:current_entry;

    p [label = &quot;p = c - current_entry.previous_entry_length&quot;, shape = plaintext];
    p -&gt; entry:previous_entry [minlen = 2.0];

}" />
</p>
<p>压缩列表的从表尾向表头遍历操作就是使用这一原理实现的：
只要我们拥有了一个指向某个节点起始地址的指针，
那么通过这个指针以及这个节点的 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性，
程序就可以一直向前一个节点回溯，
最终到达压缩列表的表头节点。</p>
<p>图 7-8 展示了一个从表尾节点向表头节点进行遍历的完整过程：</p>
<ul class="simple">
<li>首先，我们拥有指向压缩列表表尾节点 <code class="docutils literal"><span class="pre">entry4</span></code> 起始地址的指针 <code class="docutils literal"><span class="pre">p1</span></code>
（指向表尾节点的指针可以通过指向压缩列表起始地址的指针加上 <code class="docutils literal"><span class="pre">zltail</span></code> 属性的值得出）；</li>
<li>通过用 <code class="docutils literal"><span class="pre">p1</span></code> 减去 <code class="docutils literal"><span class="pre">entry4</span></code> 节点 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的值，
我们得到一个指向 <code class="docutils literal"><span class="pre">entry4</span></code> 前一节点 <code class="docutils literal"><span class="pre">entry3</span></code> 起始地址的指针 <code class="docutils literal"><span class="pre">p2</span></code> ；</li>
<li>通过用 <code class="docutils literal"><span class="pre">p2</span></code> 减去 <code class="docutils literal"><span class="pre">entry3</span></code> 节点 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的值，
我们得到一个指向 <code class="docutils literal"><span class="pre">entry3</span></code> 前一节点 <code class="docutils literal"><span class="pre">entry2</span></code> 起始地址的指针 <code class="docutils literal"><span class="pre">p3</span></code> ；</li>
<li>通过用 <code class="docutils literal"><span class="pre">p3</span></code> 减去 <code class="docutils literal"><span class="pre">entry2</span></code> 节点 <code class="docutils literal"><span class="pre">previous_entry_length</span></code> 属性的值，
我们得到一个指向 <code class="docutils literal"><span class="pre">entry2</span></code> 前一节点 <code class="docutils literal"><span class="pre">entry1</span></code> 起始地址的指针 <code class="docutils literal"><span class="pre">p4</span></code> ，
<code class="docutils literal"><span class="pre">entry1</span></code> 为压缩列表的表头节点；</li>
<li>最终，
我们从表尾节点向表头节点遍历了整个列表。</li>
</ul>
<p class="graphviz">
<img src="../../_images/graphviz-cc50542b1187b200cb89ed4b37695dcbf9db4e1f.png" alt="digraph {

    rankdir = BT;

    node [shape = record];

    entry1 [label = &quot; zlbytes | zltail | zllen | &lt;e1&gt; entry1 | &lt;e2&gt; entry2 | &lt;e3&gt; entry3 | &lt;e4&gt; entry4 | zlend &quot;];

    node [shape = plaintext];

    p1 -&gt; entry1:e4;

}" />
</p>
<p class="graphviz">
<img src="../../_images/graphviz-e9faeda02f5f8d08f81e08e2feb125a565df5e91.png" alt="digraph {

    rankdir = BT;

    node [shape = record];

    entry2 [label = &quot; zlbytes | zltail | zllen | &lt;e1&gt; entry1 | &lt;e2&gt; entry2 | &lt;e3&gt; entry3 | &lt;e4&gt; entry4 | zlend &quot;];

    node [shape = plaintext];

    p2 [label = &quot;p2 = p1 - entry4.previous_entry_length&quot;];
    p2 -&gt; entry2:e3;

}" />
</p>
<p class="graphviz">
<img src="../../_images/graphviz-6c4fdcd56711eb2abd46e671f30269cb52411e71.png" alt="digraph {

    rankdir = BT;

    node [shape = record];

    entry3 [label = &quot; zlbytes | zltail | zllen | &lt;e1&gt; entry1 | &lt;e2&gt; entry2 | &lt;e3&gt; entry3 | &lt;e4&gt; entry4 | zlend &quot;];

    node [shape = plaintext];

    p3 [label = &quot;p3 = p2 - entry3.previous_entry_length&quot;];
    p3 -&gt; entry3:e2;

}" />
</p>
<p class="graphviz">
<img src="../../_images/graphviz-85d5042240608e1f9833b78027ab9de6790392a7.png" alt="digraph {

    label = &quot;\n 图 7-8    一个从表尾向表头遍历的例子&quot;;

    rankdir = BT;

    node [shape = record];

    entry4 [label = &quot; zlbytes | zltail | zllen | &lt;e1&gt; entry1 | &lt;e2&gt; entry2 | &lt;e3&gt; entry3 | &lt;e4&gt; entry4 | zlend &quot;];

    node [shape = plaintext];

    p4 [label = &quot;p4 = p3 - entry2.previous_entry_length&quot;];
    p4 -&gt; entry4:e1;

}" />
</p>
</div>
<div class="section" id="encoding">
<h2>encoding<a class="headerlink" href="#encoding" title="Permalink to this headline">¶</a></h2>
<p>节点的 <code class="docutils literal"><span class="pre">encoding</span></code> 属性记录了节点的 <code class="docutils literal"><span class="pre">content</span></code> 属性所保存数据的类型以及长度：</p>
<ul class="simple">
<li>一字节、两字节或者五字节长，
值的最高位为 <code class="docutils literal"><span class="pre">00</span></code> 、 <code class="docutils literal"><span class="pre">01</span></code> 或者 <code class="docutils literal"><span class="pre">10</span></code> 的是字节数组编码：
这种编码表示节点的 <code class="docutils literal"><span class="pre">content</span></code> 属性保存着字节数组，
数组的长度由编码除去最高两位之后的其他位记录；</li>
<li>一字节长，
值的最高位以 <code class="docutils literal"><span class="pre">11</span></code> 开头的是整数编码：
这种编码表示节点的 <code class="docutils literal"><span class="pre">content</span></code> 属性保存着整数值，
整数值的类型和长度由编码除去最高两位之后的其他位记录；</li>
</ul>
<p>表 7-2 记录了所有可用的字节数组编码，
而表 7-3 则记录了所有可用的整数编码。
表格中的下划线 <code class="docutils literal"><span class="pre">_</span></code> 表示留空，
而 <code class="docutils literal"><span class="pre">b</span></code> 、 <code class="docutils literal"><span class="pre">x</span></code> 等变量则代表实际的二进制数据，
为了方便阅读，
多个字节之间用空格隔开。</p>
<hr class="docutils" />
<p>表 7-2    字节数组编码</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="9%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">编码</th>
<th class="head">编码长度</th>
<th class="head"><code class="docutils literal"><span class="pre">content</span></code> 属性保存的值</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">00bbbbbb</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code> 字节</td>
<td>长度小于等于 <code class="docutils literal"><span class="pre">63</span></code> 字节的字节数组。</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">01bbbbbb</span> <span class="pre">xxxxxxxx</span></code></td>
<td><code class="docutils literal"><span class="pre">2</span></code> 字节</td>
<td>长度小于等于 <code class="docutils literal"><span class="pre">16383</span></code> 字节的字节数组。</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">10______</span> <span class="pre">aaaaaaaa</span> <span class="pre">bbbbbbbb</span> <span class="pre">cccccccc</span> <span class="pre">dddddddd</span></code></td>
<td><code class="docutils literal"><span class="pre">5</span></code> 字节</td>
<td>长度小于等于 <code class="docutils literal"><span class="pre">4294967295</span></code> 的字节数组。</td>
</tr>
</tbody>
</table>
<p>表 7-3    整数编码</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="11%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">编码</th>
<th class="head">编码长度</th>
<th class="head"><code class="docutils literal"><span class="pre">content</span></code> 属性保存的值</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">11000000</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code> 字节</td>
<td><code class="docutils literal"><span class="pre">int16_t</span></code> 类型的整数。</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">11010000</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code> 字节</td>
<td><code class="docutils literal"><span class="pre">int32_t</span></code> 类型的整数。</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">11100000</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code> 字节</td>
<td><code class="docutils literal"><span class="pre">int64_t</span></code> 类型的整数。</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">11110000</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code> 字节</td>
<td><code class="docutils literal"><span class="pre">24</span></code> 位有符号整数。</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">11111110</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code> 字节</td>
<td><code class="docutils literal"><span class="pre">8</span></code> 位有符号整数。</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">1111xxxx</span></code></td>
<td><code class="docutils literal"><span class="pre">1</span></code> 字节</td>
<td>使用这一编码的节点没有相应的 <code class="docutils literal"><span class="pre">content</span></code> 属性，
因为编码本身的 <code class="docutils literal"><span class="pre">xxxx</span></code> 四个位已经保存了一个介于 <code class="docutils literal"><span class="pre">0</span></code> 和 <code class="docutils literal"><span class="pre">12</span></code> 之间的值，
所以它无须 <code class="docutils literal"><span class="pre">content</span></code> 属性。</td>
</tr>
</tbody>
</table>
</div>
<hr class="docutils" />
<div class="section" id="content">
<h2>content<a class="headerlink" href="#content" title="Permalink to this headline">¶</a></h2>
<p>节点的 <code class="docutils literal"><span class="pre">content</span></code> 属性负责保存节点的值，
节点值可以是一个字节数组或者整数，
值的类型和长度由节点的 <code class="docutils literal"><span class="pre">encoding</span></code> 属性决定。</p>
<p>图 7-9 展示了一个保存字节数组的节点示例：</p>
<ul class="simple">
<li>编码的最高两位 <code class="docutils literal"><span class="pre">00</span></code> 表示节点保存的是一个字节数组；</li>
<li>编码的后六位 <code class="docutils literal"><span class="pre">001011</span></code> 记录了字节数组的长度 <code class="docutils literal"><span class="pre">11</span></code> ；</li>
<li><code class="docutils literal"><span class="pre">content</span></code> 属性保存着节点的值 <code class="docutils literal"><span class="pre">&quot;hello</span> <span class="pre">world&quot;</span></code> 。</li>
</ul>
<p class="graphviz">
<img src="../../_images/graphviz-556d0890afb2675ce91d30a1b2cb2a429d0c217f.png" alt="digraph {

    label = &quot;\n 图 7-9    保存着字节数组 \&quot;hello world\&quot; 的节点&quot;;

    node [shape = record];

    entry [label = &quot; previous_entry_length \n ... | encoding \n 00001011 | content \n \&quot;hello world\&quot; &quot;];

}" />
</p>
<p>图 7-10 展示了一个保存整数值的节点示例：</p>
<ul class="simple">
<li>编码 <code class="docutils literal"><span class="pre">11000000</span></code> 表示节点保存的是一个 <code class="docutils literal"><span class="pre">int16_t</span></code> 类型的整数值；</li>
<li><code class="docutils literal"><span class="pre">content</span></code> 属性保存着节点的值 <code class="docutils literal"><span class="pre">10086</span></code> 。</li>
</ul>
<p class="graphviz">
<img src="../../_images/graphviz-cfb376f8015f3af9f59acd30dc71a35e90c6d763.png" alt="digraph {

    label = &quot;\n 图 7-10    保存着整数值 10086 的节点&quot;;

    node [shape = record];

    entry [label = &quot; previous_entry_length \n ... | encoding \n 11000000 | content \n 10086 &quot;];

}" />
</p>
</div>
</div>



            <div class="section" id="discuss">
    <h2>
        讨论
        <a class="headerlink" href="#discuss" title="永久链接至标题">¶</a>
    </h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'redisbookv1'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">Redis 设计与实现</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, 黄健宏（huangz）.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>